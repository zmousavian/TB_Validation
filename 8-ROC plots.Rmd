---
title: "New Olink Study"
author: "Zaynab Mousavian"
date: "7 August 2024"
output:
  html_document: default
  pdf_document: default
subtitle: ROC plots
---

```{r setup, include=FALSE}
# Set global options for all chunks
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
```

# Load R packages

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(multiview)
library(tidyr)
library(tidyverse)
library(caret)
library(pROC)
library(patchwork)
```

# Function for visualization ROC plot with Youden index with text

```{r}
ROCplotwithYoudenText_func <- function(rocObj, ciData, specific_specificity_1 = NULL,marker_name=NULL){
  
  youden_index <- rocObj$sensitivities + rocObj$specificities - 1
  optimal_threshold_index <- which.max(youden_index)
  optimal_threshold <- rocObj$thresholds[optimal_threshold_index]
  
  optimal_sensitivity <- rocObj$sensitivities[optimal_threshold_index]
  optimal_specificity <- rocObj$specificities[optimal_threshold_index]
 
  plot <- ggroc(rocObj,legacy.axes = TRUE)  + geom_abline(slope=1, intercept = 0, linetype = "dashed", alpha=0.7, color = "grey") + coord_equal() + 
    geom_ribbon(data = ciData, aes(x = 1-x, ymin = lower, ymax = upper), fill = "steelblue", alpha= 0.2) + 
    ggtitle(paste0("AUC=",round(roc0$auc,2)," (",gsub(" \\(DeLong\\)","",capture.output(roc0$ci)),")"))+
    labs(x = "1 - Specificity",
         y = "Sensitivity")+
    theme(axis.text.x = element_text(size = 12),  
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size=12),
          plot.title = element_text(size=9),
          panel.background = element_rect(fill = "white", color = NA),  
          plot.background = element_rect(fill = "white", color = NA), 
          panel.grid.major = element_blank(),  
          panel.grid.minor = element_blank(),
          panel.border = element_rect(color ="grey", fill = NA))
   
 if (!is.null(specific_specificity_1)) {
    specific_fpr_1 <- 1 - specific_specificity_1
    closest_specificity_index_1 <- which.min(abs(rocObj$specificities - specific_specificity_1))
    sensitivity_at_specific_specificity_1 <- rocObj$sensitivities[closest_specificity_index_1]
    
    plot <- plot +
      geom_point(aes(x = specific_fpr_1, y = sensitivity_at_specific_specificity_1), color = "#32CD32", size = 2) +
      geom_text(aes(x = specific_fpr_1, y = sensitivity_at_specific_specificity_1, 
                    label = paste0("(%", round(sensitivity_at_specific_specificity_1, 2)*100,", %",round(specific_specificity_1, 2)*100, ")")), 
                hjust = 1, vjust = 1.5,x = 0.95, y = 0.05, color = "#32CD32", size = 4)
 }
  specific_specificity_2 <- NULL
  if (!is.null(specific_specificity_2)) {
    specific_fpr_2 <- 1 - specific_specificity_2
    closest_specificity_index_2 <- which.min(abs(rocObj$specificities - specific_specificity_2))
    sensitivity_at_specific_specificity_2 <- rocObj$sensitivities[closest_specificity_index_2]
    
    plot <- plot +
      geom_point(aes(x = specific_fpr_2, y = sensitivity_at_specific_specificity_2), color = "lightblue", size = 2) +
      geom_text(aes(x = specific_fpr_2, y = sensitivity_at_specific_specificity_2, 
                    label = paste0("(%", round(sensitivity_at_specific_specificity_2, 2)*100,", %",round(specific_specificity_2, 2)*100, ")")), 
                hjust = 1, vjust = -0.5,x = 0.95, y = 0.05, color = "lightblue", size = 4)
    }
  if (!is.null(marker_name)) {
  
  plot <- plot +
    annotate("text", x = 0.95, y = 0.05, 
             label = marker_name, 
             hjust = 1, vjust = 0, 
             color = "blue", size = 4, fontface = "italic")
  }
  plot <- plot +
    geom_vline(xintercept = 0.3, linetype = "dashed", color = "black") + 
    geom_hline(yintercept = 0.9, linetype = "dashed", color = "black") + 
    geom_segment(aes(x = 0, xend = 0.3, y = 0.9, yend = 0.9), linetype = "solid", color = "#32CD32") +  
    geom_segment(aes(x = 0.3, xend = 0.3, y = 0.9, yend = 1), linetype = "solid", color = "#32CD32") +  
    geom_segment(aes(x = 0, xend = 0, y = 0.9, yend = 1), linetype = "solid", color = "#32CD32") +  
    geom_segment(aes(x = 0, xend = 0.3, y = 1, yend = 1), linetype = "solid", color = "#32CD32")  

 
  return(plot)
}
```

# Function for visualization ROC plot with Youden index

```{r}
ROCplotwithYouden_func <- function(rocObj, ciData, specific_specificity_1 = NULL,marker_name=NULL){
  
  youden_index <- rocObj$sensitivities + rocObj$specificities - 1
  optimal_threshold_index <- which.max(youden_index)
  optimal_threshold <- rocObj$thresholds[optimal_threshold_index]
  

  optimal_sensitivity <- rocObj$sensitivities[optimal_threshold_index]
  optimal_specificity <- rocObj$specificities[optimal_threshold_index]
 
  plot <- ggroc(rocObj,legacy.axes = TRUE)  + geom_abline(slope=1, intercept = 0, linetype = "dashed", alpha=0.7, color = "grey") + coord_equal() + 
    geom_ribbon(data = ciData, aes(x = 1-x, ymin = lower, ymax = upper), fill = "steelblue", alpha= 0.2) + 
    ggtitle(paste0("AUC=",round(roc0$auc,2)," (",gsub(" \\(DeLong\\)","",capture.output(roc0$ci)),")"))+
    labs(x = "1 - Specificity",
         y = "Sensitivity")+
    theme(axis.text.x = element_text(size = 12),  # Increase size of x-axis text
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size=12),
          plot.title = element_text(size=9),
          panel.background = element_rect(fill = "white", color = NA),  
          plot.background = element_rect(fill = "white", color = NA), 
          panel.grid.major = element_blank(),  
          panel.grid.minor = element_blank(),
          panel.border = element_rect(color = "gray", fill = NA))
if (!is.null(specific_specificity_1)) {
    specific_fpr_1 <- 1 - specific_specificity_1
    closest_specificity_index_1 <- which.min(abs(rocObj$specificities - specific_specificity_1))
    sensitivity_at_specific_specificity_1 <- rocObj$sensitivities[closest_specificity_index_1]
    
    plot <- plot + 
      geom_point(aes(x = specific_fpr_1, y = sensitivity_at_specific_specificity_1), color = "lightcoral", size = 2) 
 }
  specific_specificity_2 <- NULL
   if (!is.null(specific_specificity_2)) {
    specific_fpr_2 <- 1 - specific_specificity_2
    closest_specificity_index_2 <- which.min(abs(rocObj$specificities - specific_specificity_2))
    sensitivity_at_specific_specificity_2 <- rocObj$sensitivities[closest_specificity_index_2]
    
    plot <- plot + 
      geom_point(aes(x = specific_fpr_2, y = sensitivity_at_specific_specificity_2), color = "lightblue", size = 2) 
 }
   if (!is.null(marker_name)) {
  
  plot <- plot +
    annotate("text", x = 0.95, y = 0.05, 
             label = marker_name, 
             hjust = 1, vjust = 0, 
             color = "blue", size = 4, fontface = "italic")
  }
  return(plot)
}
```


# Which data? {.tabset}

## Signature including 12 proteins

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

load(file="../Data/ReadyData/generated for iScience/0.3-pearson-modules.RData")
module="turquoise"
column = match(module, modNames);
moduleGenes = modules [[column]]
moduleGenes=moduleGenes[-c(6,8,12,14)]

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```


### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

##### prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

##### Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

##### ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig1_ROCtext_discovery <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig1_ROCtext_discovery

Fig1_ROC_discovery <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig1_ROC_discovery
save(Fig1_ROC_discovery,Fig1_ROCtext_discovery,file="../Results/Figures/Fig1_ROC_discovery.RData")
```

##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig1_ROCtext_sweden <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig1_ROCtext_sweden

Fig1_ROC_sweden <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig1_ROC_sweden
save(Fig1_ROC_sweden,Fig1_ROCtext_sweden,file="../Results/Figures/Fig1_ROC_sweden.RData")
```

####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig1_ROCtext_italy <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig1_ROCtext_italy

Fig1_ROC_italy <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig1_ROC_italy
save(Fig1_ROC_italy,Fig1_ROCtext_italy,file="../Results/Figures/Fig1_ROC_italy.RData")
```




####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig1_ROCtext_both <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig1_ROCtext_both

Fig1_ROC_both <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig1_ROC_both
save(Fig1_ROC_both,Fig1_ROCtext_both,file="../Results/Figures/Fig1_ROC_both.RData")
```


####### non TB
######## load data

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr_1 <- olink 
groups_1 <- samples_second[match(row.names(dat_Expr_1),samples_second$SampleID),"modifiedType",drop=TRUE]
l=load("../Data/ReadyData/ReadyData-third-heparin-nonTB.RData")
dat_Expr_2 <- olink 
groups_2 <- samples_third[match(row.names(dat_Expr_2),samples_third$SampleID),"modifiedType",drop=TRUE]

first_dataset <- dat_Expr_1%>%
  select(moduleGenes)%>%
  mutate(Class=groups_1)

first_dataset <- first_dataset%>%
  filter(Class%in%c("Active"))

second_dataset <- dat_Expr_2%>%
  select(moduleGenes)%>%
  mutate(Class="nonTB")

dataset <- first_dataset%>%
  rbind(second_dataset)

dataset$Class <- factor(dataset$Class,levels=c("Active","nonTB"))
dataset$Class <- gsub("nonTB","Latent",dataset$Class)
dataset$Class <- factor(dataset$Class,levels=c("Active","Latent"))

data_test <- dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig8_ROCtext_A <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig8_ROCtext_A

Fig8_ROC_A <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig8_ROC_A
save(Fig8_ROC_A,Fig8_ROCtext_A,file="../Results/Figures/Fig8_ROC_A.RData")
```


## Signature including 7 proteins

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData-withoutFilteringProteins/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("IL6","CDCP1","IFN-gamma","CXCL9","VEGFA","MCP-3","CCL19")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```


##### prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

##### Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

##### ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_discovery_A <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_discovery_A

Fig2_ROC_discovery_A <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_discovery_A
save(Fig2_ROC_discovery_A,Fig2_ROCtext_discovery_A,file="../Results/Figures/Fig2_ROC_discovery_A.RData")
```

##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_sweden_A <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_sweden_A

Fig2_ROC_sweden_A <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_sweden_A
save(Fig2_ROC_sweden_A,Fig2_ROCtext_sweden_A,file="../Results/Figures/Fig2_ROC_sweden_A.RData")
```

####### italy 

######## load data

```{r}
l=load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_italy_A <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_italy_A

Fig2_ROC_italy_A <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_italy_A
save(Fig2_ROC_italy_A,Fig2_ROCtext_italy_A,file="../Results/Figures/Fig2_ROC_italy_A.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_both_A <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_both_A

Fig2_ROC_both_A <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_both_A
save(Fig2_ROCtext_both_A,Fig2_ROC_both_A,file="../Results/Figures/Fig2_ROC_both_A.RData")
```



## Signature including 6 proteins

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData-withoutFilteringProteins/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("IL6","CDCP1","IFN-gamma","CXCL9","VEGFA","MCP-3")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

##### prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

##### Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

##### ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_discovery_B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_discovery_B

Fig2_ROC_discovery_B <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_discovery_B
save(Fig2_ROC_discovery_B,Fig2_ROCtext_discovery_B,file="../Results/Figures/Fig2_ROC_discovery_B.RData")
```

##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_sweden_B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_sweden_B

Fig2_ROC_sweden_B <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_sweden_B
save(Fig2_ROC_sweden_B,Fig2_ROCtext_sweden_B,file="../Results/Figures/Fig2_ROC_sweden_B.RData")
```



####### italy 

######## load data

```{r}
l=load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_italy_B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_italy_B

Fig2_ROC_italy_B <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_italy_B
save(Fig2_ROC_italy_B,Fig2_ROCtext_italy_B,file="../Results/Figures/Fig2_ROC_italy_B.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_both_B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_both_B

Fig2_ROC_both_B <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_both_B
save(Fig2_ROCtext_both_B,Fig2_ROC_both_B,file="../Results/Figures/Fig2_ROC_both_B.RData")
```

####### non TB
######## load data

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr_1 <- olink 
groups_1 <- samples_second[match(row.names(dat_Expr_1),samples_second$SampleID),"modifiedType",drop=TRUE]
l=load("../Data/ReadyData/ReadyData-third-heparin-nonTB.RData")
dat_Expr_2 <- olink 
groups_2 <- samples_third[match(row.names(dat_Expr_2),samples_third$SampleID),"modifiedType",drop=TRUE]

first_dataset <- dat_Expr_1%>%
  select(moduleGenes)%>%
  mutate(Class=groups_1)

first_dataset <- first_dataset%>%
  filter(Class%in%c("Active"))

second_dataset <- dat_Expr_2%>%
  select(moduleGenes)%>%
  mutate(Class="nonTB")

dataset <- first_dataset%>%
  rbind(second_dataset)

dataset$Class <- factor(dataset$Class,levels=c("Active","nonTB"))
dataset$Class <- gsub("nonTB","Latent",dataset$Class)
dataset$Class <- factor(dataset$Class,levels=c("Active","Latent"))

data_test <- dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig8_ROCtext_B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig8_ROCtext_B

Fig8_ROC_B <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig8_ROC_B
save(Fig8_ROC_B,Fig8_ROCtext_B,file="../Results/Figures/Fig8_ROC_B.RData")
```



## Signature including 4 proteins

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("CDCP1","IFN-gamma","CXCL9","VEGFA")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

##### prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

##### Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

##### ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_discovery_F <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_discovery_F

Fig2_ROC_discovery_F <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_discovery_F
save(Fig2_ROC_discovery_F,Fig2_ROCtext_discovery_F,file="../Results/Figures/Fig2_ROC_discovery_F.RData")
```

##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_sweden_F <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_sweden_F

Fig2_ROC_sweden_F <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_sweden_F
save(Fig2_ROC_sweden_F,Fig2_ROCtext_sweden_F,file="../Results/Figures/Fig2_ROC_sweden_F.RData")
```



####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_italy_F <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_italy_F

Fig2_ROC_italy_F <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_italy_F
save(Fig2_ROC_italy_F,Fig2_ROCtext_italy_F,file="../Results/Figures/Fig2_ROC_italy_F.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)


data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

Fig2_ROCtext_both_F <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7)

Fig2_ROCtext_both_F

Fig2_ROC_both_F <- ROCplotwithYouden_func(roc0,dat.ci,0.7)

Fig2_ROC_both_F
save(Fig2_ROCtext_both_F,Fig2_ROC_both_F,file="../Results/Figures/Fig2_ROC_both_F.RData")
```


<!-- ## Signature including 8 proteins -->

<!-- ### Load data -->

<!-- ```{r message=FALSE, warning=FALSE} -->
<!-- l=load("../Data/ReadyData/AllDatasets-Samples.RData") -->
<!-- l=load("../Data/ReadyData/ReadyData-discovery.RData") -->
<!-- dat_Expr <- olink %>%as.data.frame() -->
<!-- groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE] -->

<!-- moduleGenes=c("IL6","CDCP1","IFN-gamma","CXCL9","VEGFA","MCP-3","CSF-1","CXCL10") -->

<!-- first_dataset <- dat_Expr%>%as.data.frame() -->
<!-- first_dataset <- first_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->
<!-- ``` -->

<!-- ### Which experiment {.tabset} -->

<!-- #### Active vs Latent -->

<!-- ##### Make train data -->

<!-- ```{r} -->
<!-- first_dataset_filtered <- first_dataset%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent")) -->
<!-- data <- first_dataset_filtered -->
<!-- ``` -->

<!-- ##### Build SVM model -->

<!-- ```{r} -->
<!-- set.seed(123) -->
<!-- #Defining SVM model -->
<!-- lpSVM <- list(type = "Classification", -->
<!--               library = "kernlab", -->
<!--               loop = NULL) -->
<!-- prm <- data.frame(parameter = c("C", "sigma"), -->
<!--                   class = rep("numeric", 2), -->
<!--                   label = c("Cost", "Sigma")) -->
<!-- lpSVM$parameters <- prm -->
<!-- svmGrid <- function(x, y, len = NULL, search = "grid") { -->
<!--   library(kernlab) -->
<!--   ## This produces low, middle and high values for sigma -->
<!--   ## (i.e. a vector with 3 elements). -->
<!--   sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE) -->
<!--   ## To use grid search: -->
<!--   if(search == "grid") { -->
<!--     out <- expand.grid(sigma = mean(as.vector(sigmas[-2])), -->
<!--                        C = 2 ^((1:len) - 3)) -->
<!--   } else { -->
<!--     ## For random search, define ranges for the parameters then -->
<!--     ## generate random values for them -->
<!--     rng <- extendrange(log(sigmas), f = .75) -->
<!--     out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])), -->
<!--                       C = 2^runif(len, min = -5, max = 8)) -->
<!--   } -->
<!--   out -->
<!-- } -->
<!-- lpSVM$grid <- svmGrid -->
<!-- svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { -->
<!--   kernlab::ksvm( -->
<!--     x = as.matrix(x), y = y, -->
<!--     kernel = "rbfdot", -->
<!--     kpar = list(sigma = param$sigma), -->
<!--     C = param$C, -->
<!--     prob.model = classProbs, -->
<!--     ... -->
<!--   ) -->
<!-- } -->

<!-- lpSVM$fit <- svmFit -->
<!-- svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL) -->
<!--   kernlab::predict(modelFit, newdata) -->
<!-- lpSVM$predict <- svmPred -->
<!-- svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL) -->
<!--   kernlab::predict(modelFit, newdata, type = "probabilities") -->
<!-- lpSVM$prob <- svmProb -->
<!-- svmSort <- function(x) x[order(x$C),] -->
<!-- lpSVM$sort <- svmSort -->
<!-- lpSVM$levels <- function(x) kernlab::lev(x) -->
<!-- ``` -->

<!-- ##### Train SVM model -->

<!-- ```{r} -->
<!-- set.seed(123) -->
<!-- fitControl <- trainControl(method = "repeatedcv", -->
<!--                              ## 10-fold CV... -->
<!--                              number = 10, -->
<!--                              ## repeated ten times -->
<!--                              repeats = 10, -->
<!--                              classProbs = TRUE, -->
<!--                              summaryFunction = twoClassSummary) -->

<!-- set.seed(123) -->
<!-- svmTune <- train(Class ~ ., data = data, -->
<!--                    method = lpSVM, -->
<!--                    preProc = c("center", "scale"), -->
<!--                    metric="ROC", -->
<!--                    tuneLength = 8, -->
<!--                    trControl = fitControl) -->
<!-- ``` -->

<!-- ##### prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data) -->
<!-- prob <- predict(svmTune, data, type="prob") -->
<!-- ``` -->

<!-- ##### Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data$Class) -->
<!-- ``` -->

<!-- ##### ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data$Class, -->
<!--               predictor = predict(svmTune, data, type = "prob")[,1], -->
<!--               levels = rev(levels(data$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_discovery_C <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_discovery_C -->

<!-- Fig2_ROC_discovery_C <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_discovery_C -->
<!-- save(Fig2_ROC_discovery_C,Fig2_ROCtext_discovery_C,file="../Results/Figures/Fig2_ROC_discovery_C.RData") -->
<!-- ``` -->

<!-- ##### Test SVM -->

<!-- ###### Which data? {.tabset} -->

<!-- ####### sweden -->

<!-- ######## load data -->

<!-- ```{r} -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData") -->
<!-- dat_Expr_third_heparin <- t(olink) -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData") -->
<!-- dat_Expr_second_sweden <- t(olink) -->

<!-- groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE] -->
<!-- groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE] -->

<!-- dat_Expr <- dat_Expr_third_heparin%>% -->
<!--   cbind(dat_Expr_second_sweden) -->
<!-- groups <- c(groups_third_heparin,groups_second_sweden) -->
<!-- ``` -->

<!-- ######## make test dataset -->

<!-- ```{r} -->
<!-- sweden_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- sweden_dataset <- sweden_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->

<!-- sweden_dataset <- sweden_dataset%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent")) -->
<!-- data_test <- sweden_dataset -->
<!-- ``` -->

<!-- ######## prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data_test) -->
<!-- prob <- predict(svmTune, data_test, type="prob") -->
<!-- ``` -->

<!-- ######## Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data_test$Class) -->
<!-- ``` -->

<!-- ######## ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data_test$Class, -->
<!--               predictor = predict(svmTune, data_test, type = "prob")[,1], -->
<!--               levels = rev(levels(data_test$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_sweden_C <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_sweden_C -->

<!-- Fig2_ROC_sweden_C <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_sweden_C -->
<!-- save(Fig2_ROC_sweden_C,Fig2_ROCtext_sweden_C,file="../Results/Figures/Fig2_ROC_sweden_C.RData") -->
<!-- ``` -->



<!-- ####### italy -->

<!-- ######## load data -->

<!-- ```{r} -->
<!-- l=load("../Data/ReadyData/ReadyData-second-italy.RData") -->
<!-- dat_Expr <- t(olink) -->
<!-- groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE] -->
<!-- ``` -->

<!-- ######## make test dataset -->

<!-- ```{r} -->
<!-- second_italy_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- second_italy_dataset <- second_italy_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->

<!-- second_italy_dataset <- second_italy_dataset%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent")) -->
<!-- data_test <- second_italy_dataset -->
<!-- ``` -->

<!-- ######## prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data_test) -->
<!-- prob <- predict(svmTune, data_test, type="prob") -->
<!-- ``` -->

<!-- ######## Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data_test$Class) -->
<!-- ``` -->

<!-- ######## ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data_test$Class, -->
<!--               predictor = predict(svmTune, data_test, type = "prob")[,1], -->
<!--               levels = rev(levels(data_test$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_italy_C <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_italy_C -->

<!-- Fig2_ROC_italy_C <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_italy_C -->
<!-- save(Fig2_ROC_italy_C,Fig2_ROCtext_italy_C,file="../Results/Figures/Fig2_ROC_italy_C.RData") -->
<!-- ``` -->



<!-- ####### both -->
<!-- ######## load data -->

<!-- ```{r} -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData") -->
<!-- dat_Expr_third_heparin <- t(olink) -->
<!-- # dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")] -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData") -->
<!-- dat_Expr_second_sweden <- t(olink) -->
<!-- # dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")] -->

<!-- groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE] -->
<!-- groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE] -->

<!-- dat_Expr <- dat_Expr_third_heparin%>% -->
<!--   cbind(dat_Expr_second_sweden) -->
<!-- groups <- c(groups_third_heparin,groups_second_sweden) -->

<!-- sweden_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- sweden_dataset <- sweden_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->

<!-- l=load("../Data/ReadyData/ReadyData-second-italy.RData") -->
<!-- dat_Expr <- t(olink) -->
<!-- groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE] -->

<!-- second_italy_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- second_italy_dataset <- second_italy_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->
<!-- ``` -->

<!-- ######## make test dataset -->

<!-- ```{r} -->
<!-- data_test_both <- sweden_dataset%>% -->
<!--   rbind(second_italy_dataset) -->

<!-- data_test_both <- data_test_both%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent")) -->
<!-- data_test <- data_test_both -->
<!-- ``` -->

<!-- ######## prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data_test) -->
<!-- prob <- predict(svmTune, data_test, type="prob") -->
<!-- ``` -->

<!-- ######## Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data_test$Class) -->
<!-- ``` -->

<!-- ######## ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data_test$Class, -->
<!--               predictor = predict(svmTune, data_test, type = "prob")[,1], -->
<!--               levels = rev(levels(data_test$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_both_C <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_both_C -->

<!-- Fig2_ROC_both_C <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_both_C -->
<!-- save(Fig2_ROCtext_both_C,Fig2_ROC_both_C,file="../Results/Figures/Fig2_ROC_both_C.RData") -->
<!-- ``` -->



<!-- ## Signature including 6 proteins + CXCL10 -->

<!-- ### Load data -->

<!-- ```{r message=FALSE, warning=FALSE} -->
<!-- l=load("../Data/ReadyData/AllDatasets-Samples.RData") -->
<!-- l=load("../Data/ReadyData/ReadyData-discovery.RData") -->
<!-- dat_Expr <- olink %>%as.data.frame() -->
<!-- groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE] -->

<!-- moduleGenes=c("IL6","CDCP1","IFN-gamma","CXCL9","VEGFA","MCP-3","CXCL10") -->

<!-- first_dataset <- dat_Expr%>%as.data.frame() -->
<!-- first_dataset <- first_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->
<!-- ``` -->

<!-- ### Which experiment {.tabset} -->

<!-- #### Active vs Latent -->

<!-- ##### Make train data -->

<!-- ```{r} -->
<!-- first_dataset_filtered <- first_dataset%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent")) -->
<!-- data <- first_dataset_filtered -->
<!-- ``` -->

<!-- ##### Build SVM model -->

<!-- ```{r} -->
<!-- set.seed(123) -->
<!-- #Defining SVM model -->
<!-- lpSVM <- list(type = "Classification", -->
<!--               library = "kernlab", -->
<!--               loop = NULL) -->
<!-- prm <- data.frame(parameter = c("C", "sigma"), -->
<!--                   class = rep("numeric", 2), -->
<!--                   label = c("Cost", "Sigma")) -->
<!-- lpSVM$parameters <- prm -->
<!-- svmGrid <- function(x, y, len = NULL, search = "grid") { -->
<!--   library(kernlab) -->
<!--   ## This produces low, middle and high values for sigma -->
<!--   ## (i.e. a vector with 3 elements). -->
<!--   sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE) -->
<!--   ## To use grid search: -->
<!--   if(search == "grid") { -->
<!--     out <- expand.grid(sigma = mean(as.vector(sigmas[-2])), -->
<!--                        C = 2 ^((1:len) - 3)) -->
<!--   } else { -->
<!--     ## For random search, define ranges for the parameters then -->
<!--     ## generate random values for them -->
<!--     rng <- extendrange(log(sigmas), f = .75) -->
<!--     out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])), -->
<!--                       C = 2^runif(len, min = -5, max = 8)) -->
<!--   } -->
<!--   out -->
<!-- } -->
<!-- lpSVM$grid <- svmGrid -->
<!-- svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { -->
<!--   kernlab::ksvm( -->
<!--     x = as.matrix(x), y = y, -->
<!--     kernel = "rbfdot", -->
<!--     kpar = list(sigma = param$sigma), -->
<!--     C = param$C, -->
<!--     prob.model = classProbs, -->
<!--     ... -->
<!--   ) -->
<!-- } -->

<!-- lpSVM$fit <- svmFit -->
<!-- svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL) -->
<!--   kernlab::predict(modelFit, newdata) -->
<!-- lpSVM$predict <- svmPred -->
<!-- svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL) -->
<!--   kernlab::predict(modelFit, newdata, type = "probabilities") -->
<!-- lpSVM$prob <- svmProb -->
<!-- svmSort <- function(x) x[order(x$C),] -->
<!-- lpSVM$sort <- svmSort -->
<!-- lpSVM$levels <- function(x) kernlab::lev(x) -->
<!-- ``` -->

<!-- ##### Train SVM model -->

<!-- ```{r} -->
<!-- set.seed(123) -->
<!-- fitControl <- trainControl(method = "repeatedcv", -->
<!--                              ## 10-fold CV... -->
<!--                              number = 10, -->
<!--                              ## repeated ten times -->
<!--                              repeats = 10, -->
<!--                              classProbs = TRUE, -->
<!--                              summaryFunction = twoClassSummary) -->

<!-- set.seed(123) -->
<!-- svmTune <- train(Class ~ ., data = data, -->
<!--                    method = lpSVM, -->
<!--                    preProc = c("center", "scale"), -->
<!--                    metric="ROC", -->
<!--                    tuneLength = 8, -->
<!--                    trControl = fitControl) -->
<!-- ``` -->

<!-- ##### prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data) -->
<!-- prob <- predict(svmTune, data, type="prob") -->
<!-- ``` -->

<!-- ##### Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data$Class) -->
<!-- ``` -->

<!-- ##### ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data$Class, -->
<!--               predictor = predict(svmTune, data, type = "prob")[,1], -->
<!--               levels = rev(levels(data$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_discovery_D <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_discovery_D -->

<!-- Fig2_ROC_discovery_D <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_discovery_D -->
<!-- save(Fig2_ROC_discovery_D,Fig2_ROCtext_discovery_D,file="../Results/Figures/Fig2_ROC_discovery_D.RData") -->
<!-- ``` -->

<!-- ##### Test SVM -->

<!-- ###### Which data? {.tabset} -->

<!-- ####### sweden -->

<!-- ######## load data -->

<!-- ```{r} -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData") -->
<!-- dat_Expr_third_heparin <- t(olink) -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData") -->
<!-- dat_Expr_second_sweden <- t(olink) -->

<!-- groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE] -->
<!-- groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE] -->

<!-- dat_Expr <- dat_Expr_third_heparin%>% -->
<!--   cbind(dat_Expr_second_sweden) -->
<!-- groups <- c(groups_third_heparin,groups_second_sweden) -->
<!-- ``` -->

<!-- ######## make test dataset -->

<!-- ```{r} -->
<!-- sweden_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- sweden_dataset <- sweden_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->

<!-- sweden_dataset <- sweden_dataset%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent")) -->
<!-- data_test <- sweden_dataset -->
<!-- ``` -->

<!-- ######## prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data_test) -->
<!-- prob <- predict(svmTune, data_test, type="prob") -->
<!-- ``` -->

<!-- ######## Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data_test$Class) -->
<!-- ``` -->

<!-- ######## ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data_test$Class, -->
<!--               predictor = predict(svmTune, data_test, type = "prob")[,1], -->
<!--               levels = rev(levels(data_test$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_sweden_D <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_sweden_D -->

<!-- Fig2_ROC_sweden_D <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_sweden_D -->
<!-- save(Fig2_ROC_sweden_D,Fig2_ROCtext_sweden_D,file="../Results/Figures/Fig2_ROC_sweden_D.RData") -->
<!-- ``` -->



<!-- ####### italy -->

<!-- ######## load data -->

<!-- ```{r} -->
<!-- l=load("../Data/ReadyData/ReadyData-second-italy.RData") -->
<!-- dat_Expr <- t(olink) -->
<!-- groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE] -->
<!-- ``` -->

<!-- ######## make test dataset -->

<!-- ```{r} -->
<!-- second_italy_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- second_italy_dataset <- second_italy_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->

<!-- second_italy_dataset <- second_italy_dataset%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent")) -->
<!-- data_test <- second_italy_dataset -->
<!-- ``` -->

<!-- ######## prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data_test) -->
<!-- prob <- predict(svmTune, data_test, type="prob") -->
<!-- ``` -->

<!-- ######## Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data_test$Class) -->
<!-- ``` -->

<!-- ######## ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data_test$Class, -->
<!--               predictor = predict(svmTune, data_test, type = "prob")[,1], -->
<!--               levels = rev(levels(data_test$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_italy_D <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_italy_D -->

<!-- Fig2_ROC_italy_D <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_italy_D -->
<!-- save(Fig2_ROC_italy_D,Fig2_ROCtext_italy_D,file="../Results/Figures/Fig2_ROC_italy_D.RData") -->
<!-- ``` -->



<!-- ####### both -->
<!-- ######## load data -->

<!-- ```{r} -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData") -->
<!-- dat_Expr_third_heparin <- t(olink) -->
<!-- # dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")] -->
<!-- load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData") -->
<!-- dat_Expr_second_sweden <- t(olink) -->
<!-- # dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")] -->

<!-- groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE] -->
<!-- groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE] -->

<!-- dat_Expr <- dat_Expr_third_heparin%>% -->
<!--   cbind(dat_Expr_second_sweden) -->
<!-- groups <- c(groups_third_heparin,groups_second_sweden) -->

<!-- sweden_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- sweden_dataset <- sweden_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->

<!-- l=load("../Data/ReadyData/ReadyData-second-italy.RData") -->
<!-- dat_Expr <- t(olink) -->
<!-- groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE] -->

<!-- second_italy_dataset <- t(dat_Expr)%>%as.data.frame() -->
<!-- second_italy_dataset <- second_italy_dataset%>% -->
<!--   select(moduleGenes)%>% -->
<!--   mutate(Class=groups) -->
<!-- ``` -->

<!-- ######## make test dataset -->

<!-- ```{r} -->
<!-- data_test_both <- sweden_dataset%>% -->
<!--   rbind(second_italy_dataset) -->

<!-- data_test_both <- data_test_both%>% -->
<!--   filter(Class%in%c("Active","Latent")) -->

<!-- data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent")) -->
<!-- data_test <- data_test_both -->
<!-- ``` -->

<!-- ######## prediction -->

<!-- ```{r} -->
<!-- pred <- predict(svmTune, data_test) -->
<!-- prob <- predict(svmTune, data_test, type="prob") -->
<!-- ``` -->

<!-- ######## Confusion matrix -->

<!-- ```{r} -->
<!-- confusionMatrix(pred,data_test$Class) -->
<!-- ``` -->

<!-- ######## ROC curve -->

<!-- ```{r} -->
<!-- roc0 <- roc(response = data_test$Class, -->
<!--               predictor = predict(svmTune, data_test, type = "prob")[,1], -->
<!--               levels = rev(levels(data_test$Class)),ci=TRUE) -->

<!-- ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25)) -->
<!-- dat.ci <- data.frame(x = as.numeric(rownames(ciobj)), -->
<!--                      lower = ciobj[, 1], -->
<!--                      upper = ciobj[, 3]) -->

<!-- Fig2_ROCtext_both_D <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROCtext_both_D -->

<!-- Fig2_ROC_both_D <- ROCplotwithYouden_func(roc0,dat.ci,0.7) -->

<!-- Fig2_ROC_both_D -->
<!-- save(Fig2_ROCtext_both_D,Fig2_ROC_both_D,file="../Results/Figures/Fig2_ROC_both_D.RData") -->
<!-- ``` -->



## Signature including IL6

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("IL6")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_IL6 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROCtext_discovery_IL6 

suppFig2_ROC_discovery_IL6  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROC_discovery_IL6 
save(suppFig2_ROCtext_discovery_IL6,suppFig2_ROC_discovery_IL6,file="../Results/Figures/suppFig2_ROC_discovery_IL6.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_IL6 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROCtext_sweden_IL6 

suppFig2_ROC_sweden_IL6  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROC_sweden_IL6 
save(suppFig2_ROCtext_sweden_IL6,suppFig2_ROC_sweden_IL6,file="../Results/Figures/suppFig2_ROC_sweden_IL6.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_IL6 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROCtext_italy_IL6

suppFig2_ROC_italy_IL6 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROC_italy_IL6
save(suppFig2_ROCtext_italy_IL6,suppFig2_ROC_italy_IL6,file="../Results/Figures/suppFig2_ROC_italy_IL6.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_IL6 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROCtext_both_IL6

suppFig2_ROC_both_IL6 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL6")

suppFig2_ROC_both_IL6
save(suppFig2_ROCtext_both_IL6,suppFig2_ROC_both_IL6,file="../Results/Figures/suppFig2_ROC_IL6.RData")
```




## Signature including CDCP1

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("CDCP1")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_CDCP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROCtext_discovery_CDCP1 

suppFig2_ROC_discovery_CDCP1  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROC_discovery_CDCP1 
save(suppFig2_ROCtext_discovery_CDCP1,suppFig2_ROC_discovery_CDCP1,file="../Results/Figures/suppFig2_ROC_discovery_CDCP1.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_CDCP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROCtext_sweden_CDCP1 

suppFig2_ROC_sweden_CDCP1  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROC_sweden_CDCP1 
save(suppFig2_ROCtext_sweden_CDCP1,suppFig2_ROC_sweden_CDCP1,file="../Results/Figures/suppFig2_ROC_sweden_CDCP1.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_CDCP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROCtext_italy_CDCP1

suppFig2_ROC_italy_CDCP1 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROC_italy_CDCP1
save(suppFig2_ROCtext_italy_CDCP1,suppFig2_ROC_italy_CDCP1,file="../Results/Figures/suppFig2_ROC_italy_CDCP1.RData")
```




####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_CDCP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROCtext_both_CDCP1

suppFig2_ROC_both_CDCP1 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CDCP1")

suppFig2_ROC_both_CDCP1
save(suppFig2_ROCtext_both_CDCP1,suppFig2_ROC_both_CDCP1,file="../Results/Figures/suppFig2_ROC_CDCP1.RData")
```




## Signature including VEGFA

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("VEGFA")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_VEGFA <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROCtext_discovery_VEGFA 

suppFig2_ROC_discovery_VEGFA  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROC_discovery_VEGFA 
save(suppFig2_ROCtext_discovery_VEGFA,suppFig2_ROC_discovery_VEGFA,file="../Results/Figures/suppFig2_ROC_discovery_VEGFA.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_VEGFA <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROCtext_sweden_VEGFA 

suppFig2_ROC_sweden_VEGFA  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROC_sweden_VEGFA 
save(suppFig2_ROCtext_sweden_VEGFA,suppFig2_ROC_sweden_VEGFA,file="../Results/Figures/suppFig2_ROC_sweden_VEGFA.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_VEGFA <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROCtext_italy_VEGFA

suppFig2_ROC_italy_VEGFA <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROC_italy_VEGFA
save(suppFig2_ROCtext_italy_VEGFA,suppFig2_ROC_italy_VEGFA,file="../Results/Figures/suppFig2_ROC_italy_VEGFA.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_VEGFA <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROCtext_both_VEGFA

suppFig2_ROC_both_VEGFA <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"VEGFA")

suppFig2_ROC_both_VEGFA
save(suppFig2_ROCtext_both_VEGFA,suppFig2_ROC_both_VEGFA,file="../Results/Figures/suppFig2_ROC_VEGFA.RData")
```




## Signature including MCP-3

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("MCP-3")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_MCP3 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROCtext_discovery_MCP3 

suppFig2_ROC_discovery_MCP3  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROC_discovery_MCP3 
save(suppFig2_ROCtext_discovery_MCP3,suppFig2_ROC_discovery_MCP3,file="../Results/Figures/suppFig2_ROC_discovery_MCP3.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_MCP3 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROCtext_sweden_MCP3 

suppFig2_ROC_sweden_MCP3  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROC_sweden_MCP3 
save(suppFig2_ROCtext_sweden_MCP3,suppFig2_ROC_sweden_MCP3,file="../Results/Figures/suppFig2_ROC_sweden_MCP3.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_MCP3 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROCtext_italy_MCP3

suppFig2_ROC_italy_MCP3 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROC_italy_MCP3
save(suppFig2_ROCtext_italy_MCP3,suppFig2_ROC_italy_MCP3,file="../Results/Figures/suppFig2_ROC_italy_MCP3.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_MCP3 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROCtext_both_MCP3

suppFig2_ROC_both_MCP3 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MCP3")

suppFig2_ROC_both_MCP3
save(suppFig2_ROCtext_both_MCP3,suppFig2_ROC_both_MCP3,file="../Results/Figures/suppFig2_ROC_MCP3.RData")
```




## Signature including IFN-gamma

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("IFN-gamma")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_IFNG <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROCtext_discovery_IFNG 

suppFig2_ROC_discovery_IFNG  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROC_discovery_IFNG 
save(suppFig2_ROCtext_discovery_IFNG,suppFig2_ROC_discovery_IFNG,file="../Results/Figures/suppFig2_ROC_discovery_IFNG.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_IFNG <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROCtext_sweden_IFNG 

suppFig2_ROC_sweden_IFNG  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROC_sweden_IFNG 
save(suppFig2_ROCtext_sweden_IFNG,suppFig2_ROC_sweden_IFNG,file="../Results/Figures/suppFig2_ROC_sweden_IFNG.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_IFNG <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROCtext_italy_IFNG

suppFig2_ROC_italy_IFNG <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROC_italy_IFNG
save(suppFig2_ROCtext_italy_IFNG,suppFig2_ROC_italy_IFNG,file="../Results/Figures/suppFig2_ROC_italy_IFNG.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_IFNG <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROCtext_both_IFNG

suppFig2_ROC_both_IFNG <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IFNG")

suppFig2_ROC_both_IFNG
save(suppFig2_ROCtext_both_IFNG,suppFig2_ROC_both_IFNG,file="../Results/Figures/suppFig2_ROC_IFNG.RData")
```




## Signature including CXCL9

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("CXCL9")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_CXCL9 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROCtext_discovery_CXCL9 

suppFig2_ROC_discovery_CXCL9  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROC_discovery_CXCL9 
save(suppFig2_ROCtext_discovery_CXCL9,suppFig2_ROC_discovery_CXCL9,file="../Results/Figures/suppFig2_ROC_discovery_CXCL9.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_CXCL9 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROCtext_sweden_CXCL9 

suppFig2_ROC_sweden_CXCL9  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROC_sweden_CXCL9 
save(suppFig2_ROCtext_sweden_CXCL9,suppFig2_ROC_sweden_CXCL9,file="../Results/Figures/suppFig2_ROC_sweden_CXCL9.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_CXCL9 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROCtext_italy_CXCL9

suppFig2_ROC_italy_CXCL9 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROC_italy_CXCL9
save(suppFig2_ROCtext_italy_CXCL9,suppFig2_ROC_italy_CXCL9,file="../Results/Figures/suppFig2_ROC_italy_CXCL9.RData")
```



####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_CXCL9 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROCtext_both_CXCL9

suppFig2_ROC_both_CXCL9 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CXCL9")

suppFig2_ROC_both_CXCL9
save(suppFig2_ROCtext_both_CXCL9,suppFig2_ROC_both_CXCL9,file="../Results/Figures/suppFig2_ROC_CXCL9.RData")
```




## Signature including CCL19

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("CCL19")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_CCL19 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROCtext_discovery_CCL19 

suppFig2_ROC_discovery_CCL19  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROC_discovery_CCL19 
save(suppFig2_ROCtext_discovery_CCL19,suppFig2_ROC_discovery_CCL19,file="../Results/Figures/suppFig2_ROC_discovery_CCL19.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_CCL19 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROCtext_sweden_CCL19 

suppFig2_ROC_sweden_CCL19  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROC_sweden_CCL19 
save(suppFig2_ROCtext_sweden_CCL19,suppFig2_ROC_sweden_CCL19,file="../Results/Figures/suppFig2_ROC_sweden_CCL19.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_CCL19 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROCtext_italy_CCL19

suppFig2_ROC_italy_CCL19 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROC_italy_CCL19
save(suppFig2_ROCtext_italy_CCL19,suppFig2_ROC_italy_CCL19,file="../Results/Figures/suppFig2_ROC_italy_CCL19.RData")
```

####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_CCL19 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROCtext_both_CCL19

suppFig2_ROC_both_CCL19 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CCL19")

suppFig2_ROC_both_CCL19
save(suppFig2_ROCtext_both_CCL19,suppFig2_ROC_both_CCL19,file="../Results/Figures/suppFig2_ROC_CCL19.RData")
```






## Signature including MMP-1

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("MMP-1")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_MMP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROCtext_discovery_MMP1 

suppFig2_ROC_discovery_MMP1  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROC_discovery_MMP1 
save(suppFig2_ROCtext_discovery_MMP1,suppFig2_ROC_discovery_MMP1,file="../Results/Figures/suppFig2_ROC_discovery_MMP1.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_MMP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROCtext_sweden_MMP1 

suppFig2_ROC_sweden_MMP1  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROC_sweden_MMP1 
save(suppFig2_ROCtext_sweden_MMP1,suppFig2_ROC_sweden_MMP1,file="../Results/Figures/suppFig2_ROC_sweden_MMP1.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_MMP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROCtext_italy_MMP1

suppFig2_ROC_italy_MMP1 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROC_italy_MMP1
save(suppFig2_ROCtext_italy_MMP1,suppFig2_ROC_italy_MMP1,file="../Results/Figures/suppFig2_ROC_italy_MMP1.RData")
```

####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_MMP1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROCtext_both_MMP1

suppFig2_ROC_both_MMP1 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"MMP1")

suppFig2_ROC_both_MMP1
save(suppFig2_ROCtext_both_MMP1,suppFig2_ROC_both_MMP1,file="../Results/Figures/suppFig2_ROC_MMP1.RData")
```





## Signature including IL7

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("IL7")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_IL7 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROCtext_discovery_IL7 

suppFig2_ROC_discovery_IL7  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROC_discovery_IL7 
save(suppFig2_ROCtext_discovery_IL7,suppFig2_ROC_discovery_IL7,file="../Results/Figures/suppFig2_ROC_discovery_IL7.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_IL7 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROCtext_sweden_IL7 

suppFig2_ROC_sweden_IL7  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROC_sweden_IL7 
save(suppFig2_ROCtext_sweden_IL7,suppFig2_ROC_sweden_IL7,file="../Results/Figures/suppFig2_ROC_sweden_IL7.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_IL7 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROCtext_italy_IL7

suppFig2_ROC_italy_IL7 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROC_italy_IL7
save(suppFig2_ROCtext_italy_IL7,suppFig2_ROC_italy_IL7,file="../Results/Figures/suppFig2_ROC_italy_IL7.RData")
```

####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_IL7 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROCtext_both_IL7

suppFig2_ROC_both_IL7 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL7")

suppFig2_ROC_both_IL7
save(suppFig2_ROCtext_both_IL7,suppFig2_ROC_both_IL7,file="../Results/Figures/suppFig2_ROC_IL7.RData")
```





## Signature including IL-12B

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("IL-12B")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_IL12B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROCtext_discovery_IL12B 

suppFig2_ROC_discovery_IL12B  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROC_discovery_IL12B 
save(suppFig2_ROCtext_discovery_IL12B,suppFig2_ROC_discovery_IL12B,file="../Results/Figures/suppFig2_ROC_discovery_IL12B.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_IL12B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROCtext_sweden_IL12B 

suppFig2_ROC_sweden_IL12B  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROC_sweden_IL12B 
save(suppFig2_ROCtext_sweden_IL12B,suppFig2_ROC_sweden_IL12B,file="../Results/Figures/suppFig2_ROC_sweden_IL12B.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_IL12B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROCtext_italy_IL12B

suppFig2_ROC_italy_IL12B <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROC_italy_IL12B
save(suppFig2_ROCtext_italy_IL12B,suppFig2_ROC_italy_IL12B,file="../Results/Figures/suppFig2_ROC_italy_IL12B.RData")
```

####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_IL12B <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROCtext_both_IL12B

suppFig2_ROC_both_IL12B <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"IL12B")

suppFig2_ROC_both_IL12B
save(suppFig2_ROCtext_both_IL12B,suppFig2_ROC_both_IL12B,file="../Results/Figures/suppFig2_ROC_IL12B.RData")
```






## Signature including CD40

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("CD40")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_CD40 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROCtext_discovery_CD40 

suppFig2_ROC_discovery_CD40  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROC_discovery_CD40 
save(suppFig2_ROCtext_discovery_CD40,suppFig2_ROC_discovery_CD40,file="../Results/Figures/suppFig2_ROC_discovery_CD40.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_CD40 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROCtext_sweden_CD40 

suppFig2_ROC_sweden_CD40  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROC_sweden_CD40 
save(suppFig2_ROCtext_sweden_CD40,suppFig2_ROC_sweden_CD40,file="../Results/Figures/suppFig2_ROC_sweden_CD40.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_CD40 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROCtext_italy_CD40

suppFig2_ROC_italy_CD40 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROC_italy_CD40
save(suppFig2_ROCtext_italy_CD40,suppFig2_ROC_italy_CD40,file="../Results/Figures/suppFig2_ROC_italy_CD40.RData")
```

####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_CD40 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROCtext_both_CD40

suppFig2_ROC_both_CD40 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"CD40")

suppFig2_ROC_both_CD40
save(suppFig2_ROCtext_both_CD40,suppFig2_ROC_both_CD40,file="../Results/Figures/suppFig2_ROC_CD40.RData")
```






## Signature including PD-L1

### Load data 

```{r message=FALSE, warning=FALSE}
l=load("../Data/ReadyData/AllDatasets-Samples.RData")
l=load("../Data/ReadyData/ReadyData-discovery.RData")
dat_Expr <- olink %>%as.data.frame()
groups <- samples_first[match(row.names(dat_Expr),samples_first$SampleID),"modifiedType",drop=TRUE]

moduleGenes=c("PD-L1")

first_dataset <- dat_Expr%>%as.data.frame()
first_dataset <- first_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

### Which experiment {.tabset} 

#### Active vs Latent

##### Make train data  

```{r}
first_dataset_filtered <- first_dataset%>%
  filter(Class%in%c("Active","Latent"))

first_dataset_filtered$Class <- factor(first_dataset_filtered$Class, levels = c("Active","Latent"))
data <- first_dataset_filtered
```

##### Build SVM model

```{r}
set.seed(123)
#Defining SVM model
lpSVM <- list(type = "Classification",
              library = "kernlab",
              loop = NULL)
prm <- data.frame(parameter = c("C", "sigma"),
                  class = rep("numeric", 2),
                  label = c("Cost", "Sigma"))
lpSVM$parameters <- prm
svmGrid <- function(x, y, len = NULL, search = "grid") {
  library(kernlab)
  ## This produces low, middle and high values for sigma 
  ## (i.e. a vector with 3 elements). 
  sigmas <- kernlab::sigest(as.matrix(x), na.action = na.omit, scaled = TRUE)  
  ## To use grid search:
  if(search == "grid") {
    out <- expand.grid(sigma = mean(as.vector(sigmas[-2])),
                       C = 2 ^((1:len) - 3))
  } else {
    ## For random search, define ranges for the parameters then
    ## generate random values for them
    rng <- extendrange(log(sigmas), f = .75)
    out <- data.frame(sigma = exp(runif(len, min = rng[1], max = rng[2])),
                      C = 2^runif(len, min = -5, max = 8))
  }
  out
}
lpSVM$grid <- svmGrid
svmFit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) { 
  kernlab::ksvm(
    x = as.matrix(x), y = y,
    kernel = "rbfdot",
    kpar = list(sigma = param$sigma),
    C = param$C,
    prob.model = classProbs,
    ...
  )
}

lpSVM$fit <- svmFit
svmPred <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata)
lpSVM$predict <- svmPred
svmProb <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  kernlab::predict(modelFit, newdata, type = "probabilities")
lpSVM$prob <- svmProb
svmSort <- function(x) x[order(x$C),]
lpSVM$sort <- svmSort
lpSVM$levels <- function(x) kernlab::lev(x)
```

##### Train SVM model

```{r}
set.seed(123)
fitControl <- trainControl(method = "repeatedcv",
                             ## 10-fold CV...
                             number = 10,
                             ## repeated ten times
                             repeats = 10,
                             classProbs = TRUE,
                             summaryFunction = twoClassSummary)
  
set.seed(123)
svmTune <- train(Class ~ ., data = data, 
                   method = lpSVM, 
                   preProc = c("center", "scale"),
                   metric="ROC",
                   tuneLength = 8,
                   trControl = fitControl)
```

######## prediction

```{r}
pred <- predict(svmTune, data)
prob <- predict(svmTune, data, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data$Class, 
              predictor = predict(svmTune, data, type = "prob")[,1], 
              levels = rev(levels(data$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_discovery_PDL1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROCtext_discovery_PDL1 

suppFig2_ROC_discovery_PDL1  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROC_discovery_PDL1 
save(suppFig2_ROCtext_discovery_PDL1,suppFig2_ROC_discovery_PDL1,file="../Results/Figures/suppFig2_ROC_discovery_PDL1.RData")
```


##### Test SVM 

###### Which data? {.tabset}

####### sweden

######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)
```

######## make test dataset

```{r}
sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

sweden_dataset <- sweden_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
sweden_dataset$Class <- factor(sweden_dataset$Class, levels = c("Active","Latent"))
data_test <- sweden_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_sweden_PDL1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROCtext_sweden_PDL1 

suppFig2_ROC_sweden_PDL1  <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROC_sweden_PDL1 
save(suppFig2_ROCtext_sweden_PDL1,suppFig2_ROC_sweden_PDL1,file="../Results/Figures/suppFig2_ROC_sweden_PDL1.RData")

```


####### italy 

######## load data

```{r}
l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]
```

######## make test dataset

```{r}
second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

second_italy_dataset <- second_italy_dataset%>%
  filter(Class%in%c("Active","Latent"))
  
second_italy_dataset$Class <- factor(second_italy_dataset$Class, levels = c("Active","Latent"))
data_test <- second_italy_dataset
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_italy_PDL1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROCtext_italy_PDL1

suppFig2_ROC_italy_PDL1 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROC_italy_PDL1
save(suppFig2_ROCtext_italy_PDL1,suppFig2_ROC_italy_PDL1,file="../Results/Figures/suppFig2_ROC_italy_PDL1.RData")
```


####### both
######## load data

```{r}
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-third-heparin.RData")
dat_Expr_third_heparin <- t(olink)
# dat_Expr_third_heparin <- dat_Expr_third_heparin[,!colnames(dat_Expr_third_heparin)%in%c("TB0166.0","TB0102","TB0161")]
load("../Data/ReadyData-withoutFilteringProteins/ReadyData-second-sweden.RData")
dat_Expr_second_sweden <- t(olink)
# dat_Expr_second_sweden <- dat_Expr_second_sweden[,!colnames(dat_Expr_second_sweden)%in%c("TB0061")]

groups_third_heparin <- samples_third[match(colnames(dat_Expr_third_heparin),samples_third$SampleID),"modifiedType",drop=TRUE]
groups_second_sweden <- samples_second[match(colnames(dat_Expr_second_sweden),samples_second$SampleID),"modifiedType",drop=TRUE]

dat_Expr <- dat_Expr_third_heparin%>%
  cbind(dat_Expr_second_sweden)
groups <- c(groups_third_heparin,groups_second_sweden)

sweden_dataset <- t(dat_Expr)%>%as.data.frame()
sweden_dataset <- sweden_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)

l=load("../Data/ReadyData/ReadyData-second-italy.RData")
dat_Expr <- t(olink)
groups <- samples_second[match(colnames(dat_Expr),samples_second$SampleID),"modifiedType",drop=TRUE]

second_italy_dataset <- t(dat_Expr)%>%as.data.frame()
second_italy_dataset <- second_italy_dataset%>%
  select(moduleGenes)%>%
  mutate(Class=groups)
```

######## make test dataset 

```{r}
data_test_both <- sweden_dataset%>%
  rbind(second_italy_dataset)

data_test_both <- data_test_both%>%
  filter(Class%in%c("Active","Latent"))
  
data_test_both$Class <- factor(data_test_both$Class, levels = c("Active","Latent"))
data_test <- data_test_both
```

######## prediction

```{r}
pred <- predict(svmTune, data_test)
prob <- predict(svmTune, data_test, type="prob")
```

######## Confusion matrix

```{r}
confusionMatrix(pred,data_test$Class)
```

######## ROC curve

```{r}
roc0 <- roc(response = data_test$Class, 
              predictor = predict(svmTune, data_test, type = "prob")[,1], 
              levels = rev(levels(data_test$Class)),ci=TRUE)

ciobj <- ci.se(roc0, specificities=seq(0, 1, l=25))
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

suppFig2_ROCtext_both_PDL1 <- ROCplotwithYoudenText_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROCtext_both_PDL1

suppFig2_ROC_both_PDL1 <- ROCplotwithYouden_func(roc0,dat.ci,0.7,"PDL1")

suppFig2_ROC_both_PDL1
save(suppFig2_ROCtext_both_PDL1,suppFig2_ROC_both_PDL1,file="../Results/Figures/suppFig2_ROC_PDL1.RData")
```



